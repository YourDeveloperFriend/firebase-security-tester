// Generated by CoffeeScript 1.6.3
(function() {
  var PEG, Q, RuleParser, fs, overrideAction, _;

  PEG = require('pegjs');

  overrideAction = require('pegjs-override-action');

  fs = require('fs');

  Q = require('q');

  _ = require('underscore');

  module.exports = RuleParser = (function() {
    function RuleParser() {}

    RuleParser.setData = function(data) {
      return this.data = data;
    };

    RuleParser.executeRule = function(ruleData, rule) {
      var $value, $variable, newData, parser, replaceWith, variableValues, _i, _len, _ref;
      if (!this.data) {
        throw new Error('Tester is not ready. Please check tester.ready()');
      }
      replaceWith = [];
      variableValues = [
        function() {
          return ruleData.data;
        }, function() {
          return ruleData.auth;
        }, function() {
          return ruleData.newData;
        }, function() {
          return ruleData.root;
        }, void 0
      ];
      _ref = ruleData.$variables;
      for ($value = _i = 0, _len = _ref.length; _i < _len; $value = ++_i) {
        $variable = _ref[$value];
        replaceWith.push("/ '" + $variable + "' ");
        variableValues.push(function() {
          return $value;
        });
      }
      newData = this.data.replace("// $variables", replaceWith);
      parser = PEG.buildParser(newData, {
        plugins: [overrideAction],
        overrideActionPlugin: {
          rules: {
            rawObject: variableValues
          }
        }
      });
      return parser.parse(rule);
    };

    RuleParser.ready = Q.nfcall(fs.readFile, __dirname + '/grammar.pegjs', 'utf8').then(function(data) {
      return RuleParser.setData(data);
    });

    return RuleParser;

  })();

}).call(this);
